<!DOCTYPE html>
<html lang="ru" ng-app="adminApp" class="dark">
<head>
  <meta charset="UTF-8" />
  <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body ng-controller="AdminController" class="bg-gray-900 text-white p-6 font-sans">

  <h1 class="text-2xl mb-4">–î–æ–¥–∞—Ç–∏ –±–ª—é–¥–æ</h1>

  <div class="space-y-2 mb-6">
    <input ng-model="newDish.name" placeholder="–ù–∞–∑–≤–∞ –±–ª—é–¥–∞"
      class="w-full p-2 bg-gray-800 border border-gray-700 rounded text-white" />

    <input ng-model="newDish.price" placeholder="–í —è–∫—É —Ü—ñ–Ω—É (—Ç–µ–∫—Å—Ç–æ–º —á–∏ —á–∏—Å–ª–æ–º)"
      class="w-full p-2 bg-gray-800 border border-gray-700 rounded text-white" />

    <label class="block w-full cursor-pointer bg-gray-800 border border-gray-700 rounded text-center py-2 hover:bg-gray-700 transition relative overflow-hidden">
      <span class="block">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–æ—Ç–æ –±–ª—é–¥–∞</span>
      <div ng-if="newDish.image" class="mt-2">
        <img ng-src="{{newDish.image}}" alt="–ü—Ä–µ–≤—é" class="w-24 h-24 object-cover rounded border border-gray-700" />
      </div>

      <input type="file" accept="image/*"
             class="absolute inset-0 opacity-0 cursor-pointer"
             onchange="angular.element(this).scope().uploadPhoto(event)">
    </label>

    <button ng-click="addDish()"
      class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded w-full mt-2">–î–æ–¥–∞—Ç–∏ —Å–º–∞–∫–æ–ª–∏–∫</button>
  </div>

  <h2 class="text-xl mb-2">–ü–æ—Ç–æ—á–Ω–µ –º–µ–Ω—é:</h2>
  <div ng-if="dishes.length === 0" class="text-gray-400">–ù–µ–º–∞ –¥–æ–¥–∞–Ω–∏—Ö —Å—Ç—Ä–∞–≤...</div>

  <div ng-repeat="dish in dishes track by $index"
       class="relative bg-gray-800 p-4 rounded-lg mb-3 group hover:shadow-xl transition">
    <div class="flex items-center space-x-4">
      <img ng-if="dish.image" ng-src="{{dish.image}}" alt="–§–æ—Ç–æ" class="w-16 h-16 object-cover rounded" />
      <div class="flex-1">
        <p class="text-lg font-semibold">{{dish.name}}</p>
        <p class="text-gray-400">{{dish.price}}</p>
      </div>
    </div>

    <button ng-click="deleteDish($index)"
            class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-xs">
      –£–¥–∞–ª–∏—Ç—å
    </button>
  </div>

  <script>
    angular.module("adminApp", []).controller("AdminController", function ($scope) {
      $scope.dishes = [];
      $scope.newDish = {};

      const GITHUB_TOKEN = "–¢–í–û–ô_–¢–û–ö–ï–ù"; // ‚ö†Ô∏è –≤—Å—Ç–∞–≤ —Å—é–¥–∞ –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω
      const USERNAME = "negeevmaks0";
      const REPO = "food-neue-essen";
      const FILE_PATH = "menu.json";

      const headers = {
        "Authorization": "token " + GITHUB_TOKEN,
        "Accept": "application/vnd.github.v3+json"
      };

      // –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–Ω—é —Å GitHub
      fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/${FILE_PATH}`, { headers })
        .then(res => {
          if (res.status === 404) {
            // –µ—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç ‚Üí —Å–æ–∑–¥–∞—ë–º –ø—É—Å—Ç–æ–µ –º–µ–Ω—é
            $scope.dishes = [];
            $scope.sha = null;
            $scope.$apply();
            return null;
          }
          return res.json();
        })
        .then(data => {
          if (!data) return;
          $scope.sha = data.sha;
          const content = atob(data.content.replace(/\n/g, ""));
          $scope.dishes = JSON.parse(content || "[]");
          $scope.$apply();
        })
        .catch(err => {
          console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ:", err);
          alert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –º–µ–Ω—é –∑ GitHub");
        });

      $scope.uploadPhoto = function (event) {
        const input = event.target;
        const reader = new FileReader();
        reader.onload = function (e) {
          $scope.$apply(() => {
            $scope.newDish.image = e.target.result;
            input.value = null;
          });
        };
        reader.readAsDataURL(input.files[0]);
      };

      function saveToGitHub() {
        const newContent = btoa(JSON.stringify($scope.dishes, null, 2));

        fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/${FILE_PATH}`, {
          method: "PUT",
          headers,
          body: JSON.stringify({
            message: "üìù –û–Ω–æ–≤–ª–µ–Ω–æ –º–µ–Ω—é —á–µ—Ä–µ–∑ –∞–¥–º—ñ–Ω–∫—É",
            content: newContent,
            sha: $scope.sha || undefined // –µ—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ –±—ã–ª–æ ‚Üí –±–µ–∑ sha
          })
        })
          .then(res => res.json())
          .then(data => {
            if (data.content) {
              $scope.sha = data.content.sha;
              console.log("‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–æ –Ω–∞ GitHub");
            } else {
              console.error("GitHub error:", data);
              alert("‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ –º–µ–Ω—é");
            }
          })
          .catch(err => {
            console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ:", err);
            alert("‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ –º–µ–Ω—é –Ω–∞ GitHub");
          });
      }

      $scope.addDish = function () {
        if (!$scope.newDish.name || !$scope.newDish.price) return;
        $scope.dishes.push({
          name: $scope.newDish.name,
          price: $scope.newDish.price,
          image: $scope.newDish.image || null
        });
        $scope.newDish = {};
        saveToGitHub();
      };

      $scope.deleteDish = function (index) {
        $scope.dishes.splice(index, 1);
        saveToGitHub();
      };
    });
  </script>
</body>
</html>
